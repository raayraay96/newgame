<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECE362 HW2 Study Animations</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Open Sans', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
            color: #e0e0e0;
        }
        .navbar {
            background-color: #1e3a8a;
            padding: 15px 20px;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        .navbar a {
            float: left;
            color: #fff;
            text-align: center;
            padding: 12px 20px;
            text-decoration: none;
            font-size: 18px;
            font-family: 'Roboto', sans-serif;
            transition: transform 0.2s, background-color 0.3s;
        }
        .navbar a:hover {
            background-color: #3b82f6;
            transform: scale(1.05);
        }
        h1 {
            font-family: 'Roboto', sans-serif;
            text-align: center;
            color: #00ff88;
            margin: 40px 0;
            font-size: 2.5em;
            text-shadow: 0 0 5px rgba(0, 255, 136, 0.5);
        }
        .content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .section {
            background: #2a2a2a;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 40px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s;
            animation: fadeIn 0.5s ease-in;
        }
        .section:hover {
            transform: translateY(-5px);
        }
        h2 {
            font-family: 'Roboto', sans-serif;
            color: #00ff88;
            margin-bottom: 15px;
        }
        .description {
            font-size: 1.1em;
            color: #b0b0b0;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        .description strong {
            color: #00ff88;
        }
        .description .tooltip {
            position: relative;
            cursor: help;
            border-bottom: 1px dotted #b0b0b0;
        }
        .description .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1e3a8a;
            color: #fff;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
            white-space: nowrap;
            z-index: 10;
        }
        .signal-container {
            display: flex;
            flex-direction: column;
            gap: 25px;
            background: #3a3a3a;
            padding: 20px;
            border-radius: 10px;
        }
        .signal-row {
            display: flex;
            align-items: center;
        }
        .signal-label {
            width: 100px;
            font-weight: 600;
            color: #b0b0b0;
        }
        .bit {
            width: 50px;
            height: 50px;
            text-align: center;
            line-height: 50px;
            border: 2px solid #555;
            border-radius: 8px;
            margin: 0 4px;
            background: #2a2a2a;
            font-size: 16px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
            position: relative;
        }
        .bit.active {
            background-color: #00ff88;
            color: #000;
            border-color: #00ff88;
            box-shadow: 0 4px 8px rgba(0, 255, 136, 0.4);
        }
        .bit.connection::after {
            content: '';
            position: absolute;
            width: 2px;
            height: 25px;
            background: #00ff88;
            bottom: -27px;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .bit.connection.visible::after {
            opacity: 1;
        }
        .controls {
            margin-top: 25px;
            text-align: center;
        }
        button {
            padding: 12px 25px;
            margin: 0 10px;
            cursor: pointer;
            background: linear-gradient(135deg, #00ff88, #00cc66);
            color: #000;
            border: none;
            border-radius: 8px;
            font-family: 'Roboto', sans-serif;
            font-size: 16px;
            transition: background 0.3s, transform 0.2s;
        }
        button:hover {
            background: linear-gradient(135deg, #00cc66, #009944);
            transform: scale(1.05);
        }
        .calculation-steps {
            margin-top: 20px;
            padding: 15px;
            background: #444;
            border-radius: 10px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease;
        }
        .calculation-steps.visible {
            max-height: 200px;
        }
        .calculation-steps p {
            margin: 10px 0;
            color: #e0e0e0;
        }
        .step-highlight {
            background-color: #00ff88;
            color: #000;
            padding: 5px;
            border-radius: 5px;
        }
        #back-to-top {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #1e3a8a;
            color: #fff;
            padding: 10px 15px;
            border-radius: 50%;
            cursor: pointer;
            display: none;
            transition: opacity 0.3s;
        }
        #back-to-top:hover {
            opacity: 0.8;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @media (max-width: 768px) {
            .navbar a {
                float: none;
                display: block;
                text-align: left;
            }
            h1 {
                font-size: 2em;
            }
            .section {
                padding: 20px;
            }
            .bit {
                width: 40px;
                height: 40px;
                line-height: 40px;
                margin: 0 2px;
            }
            .signal-label {
                width: 80px;
            }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <a href="index.html">Home</a>
        <a href="hw2.html">HW2</a>
        <a href="hw3.html">HW3</a>
        <a href="hw4.html">HW4</a>
        <a href="hw5.html">HW5</a>
        <a href="hw6.html">HW6</a>
        <a href="hw7.html">HW7</a>
    </div>
    <h1>ECE362 HW2 Study Animations</h1>
    <div class="content">
        <div class="section" id="stack-section">
            <h2>Problem 5: CPU State Stack at t=16 ms</h2>
            <div class="description">
                This problem asks what’s on the <span class="tooltip" data-tooltip="Stack: A memory area where CPU saves its state during interrupts.">stack</span> at <strong>t=16 ms</strong>. You start with the main program running, then at <strong>t=10 ms</strong>, interrupts occur (see table). By <strong>t=15 ms</strong>, another interrupt joins. With <strong>priority 0 highest</strong>, the animation shows how <strong>handle_pwm</strong> (PRI=1) interrupts <strong>handle_button</strong> (PRI=3), pushing Main and handle_button onto the stack.
            </div>
            <div class="signal-container">
                <div class="signal-row">
                    <span class="signal-label">Stack</span>
                    <div class="signal-bits" id="stack-stack"></div>
                </div>
            </div>
            <div class="calculation-steps" id="stack-steps">
                <p>t=10 ms: Main → Stack, handle_button runs</p>
                <p>t=15 ms: handle_button → Stack, handle_pwm runs</p>
                <p>Stack: [Main, handle_button]</p>
            </div>
            <div class="controls">
                <button id="stack-animate-btn">Animate</button>
                <button id="stack-steps-btn">Show Steps</button>
                <button id="stack-reset-btn">Reset</button>
            </div>
        </div>

        <div class="section" id="priority-section">
            <h2>Problem 7: Interrupt Priority (Main Thread)</h2>
            <div class="description">
                You’re in the <strong>main thread</strong> (priority 100) and need to determine the next <span class="tooltip" data-tooltip="Program Counter: Points to the next instruction the CPU will execute.">program counter</span> based on interrupt states (EN, PEND, PRI). With <strong>0=highest priority</strong> and ties broken by number, the animation shows <strong>ISR_2</strong> (PRI=0, EN=1, PEND=1) winning over ISR_3, setting PC to <strong>0x2200</strong>.
            </div>
            <div class="signal-container">
                <div class="signal-row">
                    <span class="signal-label">Interrupts</span>
                    <div class="signal-bits" id="priority-interrupts"></div>
                </div>
            </div>
            <div class="calculation-steps" id="priority-steps">
                <p>ISR_2: EN=1, PEND=1, PRI=0</p>
                <p>ISR_3: EN=1, PEND=1, PRI=0</p>
                <p>ISR_2 wins (lower number), PC = 0x2200</p>
            </div>
            <div class="controls">
                <button id="priority-animate-btn">Animate</button>
                <button id="priority-steps-btn">Show Steps</button>
                <button id="priority-reset-btn">Reset</button>
            </div>
        </div>

        <div class="section" id="flag-section">
            <h2>Problem 10: Flag Reads Between Interrupts</h2>
            <div class="description">
                A periodic <span class="tooltip" data-tooltip="Interrupt Service Routine: Code that handles an interrupt.">ISR</span> triggers every <strong>50 ms</strong> (5000 cycles at 100 kHz), setting a flag. The main thread checks this flag in a loop. This problem asks how many times it reads <strong>0</strong> between interrupts. The animation simulates cycles, showing <strong>2450 reads</strong> of 0 after the ISR clears the flag.
            </div>
            <div class="signal-container">
                <div class="signal-row">
                    <span class="signal-label">Flag</span>
                    <div class="signal-bits" id="flag-flag"></div>
                </div>
            </div>
            <div class="calculation-steps" id="flag-steps">
                <p>ISR: 4 cycles, sets flag=1</p>
                <p>Main: 100 cycles process, then flag=0</p>
                <p>Reads 0 for 5000 - 104 = 4896 cycles / 2 = 2450</p>
            </div>
            <div class="controls">
                <button id="flag-animate-btn">Animate</button>
                <button id="flag-steps-btn">Show Steps</button>
                <button id="flag-reset-btn">Reset</button>
            </div>
        </div>
    </div>
    <div id="back-to-top" onclick="scrollToTop()">↑</div>

    <script>
        // Stack Animation (Problem 5)
        function initStackAnimation() {
            const stackBits = document.getElementById('stack-stack');
            const steps = document.getElementById('stack-steps');
            const animateBtn = document.getElementById('stack-animate-btn');
            const stepsBtn = document.getElementById('stack-steps-btn');
            const resetBtn = document.getElementById('stack-reset-btn');

            stackBits.innerHTML = `
                <span class="bit">Empty</span>
                <span class="bit">Empty</span>
                <span class="bit">Empty</span>
            `;

            function animate() {
                reset();
                const stages = [
                    { text: "Main", delay: 500 },
                    { text: "h_button", delay: 1000 },
                ];

                stages.forEach((stage, i) => {
                    setTimeout(() => {
                        stackBits.children[i].textContent = stage.text;
                        stackBits.children[i].classList.add('active');
                        stackBits.children[i].classList.add('connection');
                        setTimeout(() => stackBits.children[i].classList.add('visible'), 100);
                    }, stage.delay);
                });

                setTimeout(() => highlightSteps(steps), 1500);
            }

            function reset() {
                [...stackBits.children].forEach(bit => {
                    bit.classList.remove('active', 'connection', 'visible');
                    bit.textContent = 'Empty';
                });
                steps.classList.remove('visible');
                stepsBtn.textContent = 'Show Steps';
            }

            animateBtn.addEventListener('click', animate);
            stepsBtn.addEventListener('click', () => toggleSteps(steps, stepsBtn));
            resetBtn.addEventListener('click', reset);
        }

        // Priority Animation (Problem 7)
        function initPriorityAnimation() {
            const interruptBits = document.getElementById('priority-interrupts');
            const steps = document.getElementById('priority-steps');
            const animateBtn = document.getElementById('priority-animate-btn');
            const stepsBtn = document.getElementById('priority-steps-btn');
            const resetBtn = document.getElementById('priority-reset-btn');

            interruptBits.innerHTML = `
                <span class="bit">ISR_0</span>
                <span class="bit">ISR_1</span>
                <span class="bit">ISR_2</span>
                <span class="bit">ISR_3</span>
            `;

            function animate() {
                reset();
                const stages = [
                    { index: 2, delay: 500 }, // ISR_2
                    { index: 3, delay: 1000 }, // ISR_3
                ];

                stages.forEach(stage => {
                    setTimeout(() => {
                        interruptBits.children[stage.index].classList.add('active');
                        if (stage.index === 2) {
                            interruptBits.children[stage.index].classList.add('connection');
                            setTimeout(() => interruptBits.children[stage.index].classList.add('visible'), 100);
                        }
                    }, stage.delay);
                });

                setTimeout(() => highlightSteps(steps), 1500);
            }

            function reset() {
                [...interruptBits.children].forEach(bit => {
                    bit.classList.remove('active', 'connection', 'visible');
                });
                steps.classList.remove('visible');
                stepsBtn.textContent = 'Show Steps';
            }

            animateBtn.addEventListener('click', animate);
            stepsBtn.addEventListener('click', () => toggleSteps(steps, stepsBtn));
            resetBtn.addEventListener('click', reset);
        }

        // Flag Animation (Problem 10)
        function initFlagAnimation() {
            const flagBits = document.getElementById('flag-flag');
            const steps = document.getElementById('flag-steps');
            const animateBtn = document.getElementById('flag-animate-btn');
            const stepsBtn = document.getElementById('flag-steps-btn');
            const resetBtn = document.getElementById('flag-reset-btn');

            for (let i = 0; i < 5; i++) {
                flagBits.innerHTML += '<span class="bit">0</span>';
            }

            function animate() {
                reset();
                const stages = [
                    { value: '1', delay: 500 }, // ISR sets flag
                    { value: '0', delay: 1000 }, // Main clears flag
                    { value: '0', delay: 1500 }, // Loop reads 0
                    { value: '0', delay: 2000 }, // Loop reads 0
                ];

                stages.forEach((stage, i) => {
                    setTimeout(() => {
                        flagBits.children[i].textContent = stage.value;
                        flagBits.children[i].classList.add('active');
                        if (stage.value === '1') {
                            flagBits.children[i].classList.add('connection');
                            setTimeout(() => flagBits.children[i].classList.add('visible'), 100);
                        }
                    }, stage.delay);
                });

                setTimeout(() => highlightSteps(steps), 2500);
            }

            function reset() {
                [...flagBits.children].forEach(bit => {
                    bit.classList.remove('active', 'connection', 'visible');
                    bit.textContent = '0';
                });
                steps.classList.remove('visible');
                stepsBtn.textContent = 'Show Steps';
            }

            animateBtn.addEventListener('click', animate);
            stepsBtn.addEventListener('click', () => toggleSteps(steps, stepsBtn));
            resetBtn.addEventListener('click', reset);
        }

        // Utility Functions
        function toggleSteps(steps, btn) {
            steps.classList.toggle('visible');
            btn.textContent = steps.classList.contains('visible') ? 'Hide Steps' : 'Show Steps';
        }

        function highlightSteps(steps) {
            steps.classList.add('visible');
            const paragraphs = steps.querySelectorAll('p');
            paragraphs.forEach((p, i) => {
                setTimeout(() => {
                    paragraphs.forEach(p => p.classList.remove('step-highlight'));
                    p.classList.add('step-highlight');
                }, i * 800);
            });
        }

        // Back to Top
        window.onscroll = function() {
            const btn = document.getElementById('back-to-top');
            if (document.body.scrollTop > 100 || document.documentElement.scrollTop > 100) {
                btn.style.display = 'block';
            } else {
                btn.style.display = 'none';
            }
        };

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Initialize animations
        document.addEventListener('DOMContentLoaded', () => {
            initStackAnimation();
            initPriorityAnimation();
            initFlagAnimation();
        });
    </script>
</body>
</html>